function Map(e,t,i){this.terrain=e,this.tileSubDomains=t,this.init(i)}function PlayBack(e,t,i){this.eventGroups={positions_vehicles:{},positions_infantry:{}},this.currentIds={positions_vehicles:[],positions_infantry:[]},this.map={},this.events={},this.timeline={},this.playerList={},this.playerGroups={},this.players={},this.markers={},this.matchedIcons={},this.trackTarget=!1,this.zoomedToFirstPlayer=!1,this.unknownClasses=[];var s=this;this.replayDetails=JSON.parse(e),this.sharedPresets=JSON.parse(t),this.map=new Map(this.replayDetails.map,this.replayDetails.tileSubDomains,function(e){e||s.fetch(i)})}function PlayBackList(){}function Poi(e){this.map=e,this.ready=!1,this.poiLayers={}}function Timeline(e){this.scrubber=null,this.playBack=e,this.speed=30,this.timeJump=1,this.timePointer=0,this.playing=!1,this.now,this.then=Date.now(),this.delta,this.timeBounds={min:0,max:0}}Map.prototype.init=function(e){var t=this;$.getJSON(webPath+"/maps/"+this.terrain+"/config.json",function(i){t.config=i,t.render(e)}).fail(function(){console.log("Error loading terrain config"),e(!0)})},Map.prototype.render=function(e){this.handler=new L.Map("map",{minZoom:this.config.minZoom,maxZoom:this.config.maxZoom,zoom:this.config.initZoom,attributionControl:!1}),this.currentZoomLevel=this.config.initZoom,$("#map").css("background-color",this.config.bgColor),this.rc=new L.RasterCoords(this.handler,[this.config.width,this.config.height]);var t=this.rc.unproject([0,this.config.height]),i=this.rc.unproject([this.config.width,0]);this.mapBounds=new L.LatLngBounds(t,i);var s=this.mapBounds.pad(1);this.handler.setMaxBounds(s),this.setView([this.config.height/2,this.config.width/2],this.config.initZoom);var a=this.tileSubDomains?webPath.replace("//","//{s}."):webPath;this.layer=L.tileLayer(a+"/maps/"+this.terrain+"/tiles/{z}/{x}/{y}.png",{noWrap:!0,errorTileUrl:webPath+"/assets/images/map/error-tile.png"}).addTo(this.handler),this.setupInteractionHandlers();var n=new Poi(this);n.setup(this.terrain),e(!1)},Map.prototype.setupInteractionHandlers=function(){var e=this;this.handler.on("zoomend",function(t){e.currentZoomLevel=t.target._zoom,console.log("Zoom changed",e.currentZoomLevel)}),this.handler.on("dragend",function(t){var i=e.rc.project(e.handler.getCenter()),s=e.handler.getZoom();console.log(i,s)})},Map.prototype.setView=function(e,t){this.handler.setView(this.rc.unproject(e),t)},Map.prototype.gamePointToMapPoint=function(e,t){if("1"==this.config.doubleSize)var i=2*e,s=Math.abs(2*(t-this.config.height/2));else var i=e,s=Math.abs(parseFloat(t)-parseFloat(this.config.height));return[i,s]},Map.prototype.mapPointToGamePoint=function(e,t,i){if(i=i||!1,"object"==typeof e&&(t=e.y,e=e.x),"1"==this.config.doubleSize)var s=e/2,a=Math.abs((t-this.config.height)/2);else var s=e,a=Math.abs(parseFloat(t)+parseFloat(this.config.height));return i?map.gameToGrid(s,a):[s,a]},Map.prototype.gameToGrid=function(e,t){var i=Math.round(100*e/100)/100,s=Math.round(100*t/100)/100;return[i,s]},PlayBack.prototype.fetch=function(e){var t=e?webPath+"/cache/events/"+this.replayDetails.id+".json":webPath+"/fetch-data",i=e?"GET":"POST",s=this;$.ajax({url:t,type:i,dataType:"json",data:{id:this.replayDetails.id},success:this.prepData.bind(s),error:function(e,t,i){console.log("Error fetching playback data - Status: "+t+" - Message: "+i)}})},PlayBack.prototype.prepData=function(e){var t=this;this.eventGroups.positions_vehicles=new L.LayerGroup([],{makeBoundsAware:!1}),this.eventGroups.positions_infantry=new L.LayerGroup([],{makeBoundsAware:!1}),this.eventGroups.positions_vehicles.addTo(this.map.handler),this.eventGroups.positions_infantry.addTo(this.map.handler),_.each(e,function(e){"undefined"==typeof t.eventList[e.time]&&(t.eventList[e.time]=[]),t.eventList[e.time].push(e)}),this.timeline=new Timeline(this),this.timeline.setupScrubber(this.eventList),this.timeline.changeSpeed(this.timeline.speed),this.sharedPresets.centerLat?(this.map.handler.setView([this.sharedPresets.centerLat,this.sharedPresets.centerLng],this.sharedPresets.zoom),this.timeline.timePointer=this.sharedPresets.time,this.timeline.skipTime(this.sharedPresets.time)):this.timeline.startTimer()},PlayBackList.prototype.init=function(){},Poi.prototype.setup=function(e){this.terrain=e,this.setupInteractionHandlers(),this.add()},Poi.prototype.setupInteractionHandlers=function(){var e=this;this.map.handler.on("zoomend",function(t){e.filterZoomLayers()})},Poi.prototype.add=function(){var e=this;$.getJSON(webPath+"/maps/"+this.terrain+"/poi.json",function(t){async.forEachOf(t,function(t,i,s){var a;"undefined"==typeof e.poiLayers[t.type]?("mount"!=t.type?(a=new L.featureGroup,a.addTo(e.map.handler)):a=new L.LayerGroup([],{makeBoundsAware:!0}),e.poiLayers[t.type]=a):a=e.poiLayers[t.type];var n="blank",o=[0,0],r=[30,30],h=[15,15];switch(t.type){case"hill":n="hill_ca",o=[10,0],r=[15,15],h=[7,7];break;case"rockarea":n="rockarea_ca",o=[10,0],r=[15,15],h=[7,7]}var p=L.icon({iconUrl:webPath+"/assets/images/map/markers/poi/"+n+".png",iconSize:r,iconAnchor:h,className:"poi-image--"+t.type}),l=e.map.gamePointToMapPoint(t.x,t.y),c=L.marker(e.map.rc.unproject([l[0],l[1]]),{icon:p,clickable:!1}).bindLabel(t.label,{noHide:!0,className:"poi poi-"+t.type,offset:o});a.addLayer(c),s()},function(t){e.ready=!0,e.filterZoomLayers()})}).fail(function(e){console.log("Error loading terrain POI, does the JSON file exist and is it valid JSON?",e)})},Poi.prototype.filterZoomLayers=function(){if(this.ready){var e=this,t=e.map.handler.getZoom();_.each(this.poiLayers,function(i,s){t<4&&"namecitycapital"!=s&&"namecity"!=s&&"mount"!=s&&e.map.handler.removeLayer(e.poiLayers[s]),t>3&&"mount"!=s&&e.poiLayers[s].addTo(e.map.handler),t>5&&"mount"==s&&e.poiLayers[s].addTo(e.map.handler),t<6&&"mount"==s&&e.map.handler.removeLayer(e.poiLayers[s])})}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,100)}}(),Timeline.prototype.setupScrubber=function(e){var t=this;t.timeBounds.min=parseInt(e[0].time),t.timeBounds.max=parseInt(e[e.length-1].time),"undefined"!=typeof this.playBack.sharedPresets.speed&&(this.speed=this.playBack.sharedPresets.speed),this.scrubber=$("timeline__silder").get(0),$(".timeline__silder__value").html(0),$(".timeline__silder").removeClass("timeline__silder--loading"),console.log("Range",playBack.timeBounds),playBack.eventPointer=playBack.timeBounds.min,noUiSlider.create(this.scrubber,{start:this.timeBounds.min,animate:!1,connect:"lower",step:1,range:{min:this.timeBounds.min,max:this.timeBounds.max}}),this.setupInteractionHandlers()},Timeline.prototype.setupInteractionHandlers=function(){this.scrubber.noUiSlider.on("slide",function(e){console.log("Sliding",Math.round(e[0])),this.skipTime(e[0])})},Timeline.prototype.changeSpeed=function(e){$(".timeline__speed.active").removeClass("timeline__speed--active"),$('.timeline__speed[data-speed="'+e+'"]').addClass("timeline__speed--active"),this.speed=e,60==this.speed?this.timeJump=5:this.timeJump=1},Timeline.prototype.skipTime=function(e){this.timePointer=Math.round(e),this.playBack.eventGroups.positions_vehicles.clearLayers(),this.playBack.eventGroups.positions_infantry.clearLayers(),this.playBack.markers={},this.playBack.currentIds.positions_vehicles=[],this.playBack.currentIds.positions_infantry=[],this.playing||this.startTimer()},Timeline.prototype.startTimer=function(){var e=this;this.stopTimer(),this.playing=!0,$(".timeline__toggle-playback .fa").removeClass("fa-play").addClass("fa-pause"),this.playBack.sharedPresets.trackPlayer&&(playBack.trackTarget=this.playBack.sharedPresets.trackPlayer),function t(){if(e.playing){requestAnimFrame(t),e.now=Date.now(),e.delta=e.now-e.then;var i=1e3/e.speed;if(e.delta>i){e.scrubber.noUiSlider.set(e.timePointer);var s=new Date(null);s.setSeconds(e.timePointer),$(".noUi-handle").html(s.toISOString().substr(11,8)),parseInt($(".noUi-origin").css("left"))>70?$(".noUi-handle").addClass("left-time"):$(".noUi-handle").removeClass("left-time"),e.timePointer>=e.timeBounds.max?e.stopTimer():e.playBack.showNextEvent(),e.then=e.now-e.delta%i}}}()},Timeline.prototype.stopTimer=function(){this.playing=!1,console.warn("Timer stopped"),$(".timeline__toggle-playback .fa").removeClass("fa-pause").addClass("fa-play")},$("document").ready(function(){var e=new PlayBackList;$(".playback-list").length&&e.init(),"undefined"!=typeof replayDetails&&new PlayBack(replayDetails,sharedPresets,cacheAvailable)});