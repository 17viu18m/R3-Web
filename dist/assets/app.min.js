function Events(e){this.playBack=e,this.markers=this.playBack.markers,this.map=this.playBack.map,this.timeline=this.playBack.timeline,this.list={}}function Map(e,t,i){this.terrain=e,this.tileSubDomains=t,this.init(i)}function Markers(e){this.playBack=e,this.map=e.map,this.list={},this.matchedIcons={},this.eventGroups={positions_vehicles:{},positions_infantry:{}},this.currentIds={positions_vehicles:[],positions_infantry:[]}}function Notifications(){this.enabled=!0,this.minWidth=800}function PlayBack(){this.map={},this.playerList={},this.playerGroups={},this.players={},this.trackTarget=!1,this.zoomedToFirstPlayer=!1,this.unknownClasses=[]}function Poi(e){this.map=e,this.ready=!1,this.poiLayers={}}function ReplayList(){}function Timeline(e){this.scrubber=null,this.playBack=e,this.speed=30,this.timeJump=1,this.timePointer=0,this.playing=!1,this.now,this.then=Date.now(),this.delta,this.timeBounds={min:0,max:0}}Events.prototype.showNext=function(){var e=this;"undefined"!=typeof this.list[e.timeline.timePointer]&&_.each(e.list[e.timeline.timePointer],function(t){var i=t.type,a=e.parseData(t.value);a&&e.actionType(i,t,a)}),e.timeline.timePointer+=e.timeline.timeJump},Events.prototype.parseData=function(e){var t=this;try{var i=JSON.parse(e);return i}catch(i){return console.error(e),t.timeline.stopTimer(!0),!1}},Events.prototype.actionType=function(e,t,i){var a=this;if("positions_vehicles"==e||"positions_infantry"==e)a.markers.findAndRemoveOld(t,i);else switch(e){case"get_in":a.markers.removeUnit(Object.keys(i)[0]);break;case"player_disconnected":var n=i[Object.keys(i)[0]].id,s=a.playBack.getPlayerInfo(n);"undefined"!=typeof s&&a.playback.notifications.info(s.name+" disconnected"),a.markers.removeUnit(Object.keys(i)[0]);break;case"player_connected":var n=i[Object.keys(i)[0]].id,s=a.playBack.getPlayerInfo(n);"undefined"!=typeof s&&a.playback.notifications.info(s.name+" connected");break;case"unit_awake":a.markers.removeUnit(Object.keys(i)[0]);break;case"unit_unconscious":a.attacked("downed",i);break;case"unit_killed":a.attacked("killed",i);break;case"incoming_missile":a.projectileLaunch(i);break;default:console.warn("Unknown event",e)}},Events.prototype.projectileLaunch=function(e){var t=this,i=e.victim,a=e.attacker,n=this.map.gamePointToMapPoint(a.pos[0],a.pos[1]),s=this.markers.list[i.unit],o="undefined"!=typeof s&&s.getLatLng(),r=this.playBack.getPlayerInfo(i.id),p=L.circle(this.map.rc.unproject([n[0],n[1]]),50,{weight:1,color:"red",fillColor:"#f03",fillOpacity:.5,className:"missile-launch",clickable:!1}).addTo(map.m);if(setTimeout(function(){t.map.handler.removeLayer(p)},1e3),o){var l=L.marker(this.map.rc.unproject([n[0],n[1]]),{icon:L.icon({iconUrl:webPath+"/assets/images/map/markers/"+a.ammoType.toLowerCase()+".png",iconSize:[30,30],iconAnchor:[15,15],className:"projectile-"+a.ammoType.toLowerCase()}),clickable:!1}).addTo(this.map.handler);setTimeout(function(){l.setLatLng(o)},50),setTimeout(function(){t.map.handler.removeLayer(l)},1e3)}"undefined"!=typeof r&&t.playBack.notifications.info(a.ammoType+" Launch at "+r.name)},Map.prototype.init=function(e){var t=this;$.getJSON(webPath+"/maps/"+this.terrain+"/config.json",function(i){t.config=i,t.render(e)}).fail(function(){console.log("Error loading terrain config"),e(!0)})},Map.prototype.render=function(e){this.handler=new L.Map("map",{minZoom:this.config.minZoom,maxZoom:this.config.maxZoom,zoom:this.config.initZoom,attributionControl:!1}),this.currentZoomLevel=this.config.initZoom,$("#map").css("background-color",this.config.bgColor),this.rc=new L.RasterCoords(this.handler,[this.config.width,this.config.height]);var t=this.rc.unproject([0,this.config.height]),i=this.rc.unproject([this.config.width,0]);this.mapBounds=new L.LatLngBounds(t,i);var a=this.mapBounds.pad(1);this.handler.setMaxBounds(a),this.setView([this.config.height/2,this.config.width/2],this.config.initZoom);var n=this.tileSubDomains?webPath.replace("//","//{s}."):webPath;this.layer=L.tileLayer(n+"/maps/"+this.terrain+"/tiles/{z}/{x}/{y}.png",{noWrap:!0,errorTileUrl:webPath+"/assets/images/map/error-tile.png"}).addTo(this.handler),this.setupInteractionHandlers();var s=new Poi(this);s.setup(this.terrain),e(!1)},Map.prototype.setupInteractionHandlers=function(){var e=this;this.handler.on("zoomend",function(t){e.currentZoomLevel=t.target._zoom,console.log("Zoom changed",e.currentZoomLevel)}),this.handler.on("dragend",function(t){var i=e.rc.project(e.handler.getCenter()),a=e.handler.getZoom();console.log(i,a)})},Map.prototype.setView=function(e,t){this.handler.setView(this.rc.unproject(e),t)},Map.prototype.gamePointToMapPoint=function(e,t){if("1"==this.config.doubleSize)var i=2*e,a=Math.abs(2*(t-this.config.height/2));else var i=e,a=Math.abs(parseFloat(t)-parseFloat(this.config.height));return[i,a]},Map.prototype.mapPointToGamePoint=function(e,t,i){if(i=i||!1,"object"==typeof e&&(t=e.y,e=e.x),"1"==this.config.doubleSize)var a=e/2,n=Math.abs((t-this.config.height)/2);else var a=e,n=Math.abs(parseFloat(t)+parseFloat(this.config.height));return i?map.gameToGrid(a,n):[a,n]},Map.prototype.gameToGrid=function(e,t){var i=Math.round(100*e/100)/100,a=Math.round(100*t/100)/100;return[i,a]},Markers.prototype.setupLayers=function(){this.eventGroups.positions_vehicles=new L.LayerGroup([],{makeBoundsAware:!1}),this.eventGroups.positions_infantry=new L.LayerGroup([],{makeBoundsAware:!1}),this.eventGroups.positions_vehicles.addTo(this.map.handler),this.eventGroups.positions_infantry.addTo(this.map.handler)},Markers.prototype.findAndRemoveOld=function(e,t){var i=this,a={positions_vehicles:[],positions_infantry:[]};_.each(t,function(t,n){i.add(n,t,type,e.time),i.currentIds[type].indexOf(n)<0&&i.currentIds[type].push(n),a[type].push(n)});var n=_.difference(i.currentIds[type],a[type]);_.each(n,function(t){if("undefined"!=typeof i.list[t]){var a=e.time-i.list[t].timeUpdated;a>30&&i.removeUnit(t)}})},Markers.prototype.remove=function(e){if("undefined"!=typeof this.list[e]){playBack.eventGroups.positions_infantry.removeLayer(this.list[e]._leaflet_id),playBack.eventGroups.positions_vehicles.removeLayer(this.list[e]._leaflet_id);var t=playBack.currentIds.positions_infantry.indexOf(e),i=playBack.currentIds.positions_vehicles.indexOf(e);t>-1&&playBack.currentIds.positions_infantry.splice(t,1),i>-1&&playBack.currentIds.positions_vehicles.splice(i,1),delete this.list[e]}},Notifications.prototype.setup=function(){this.setupInteractionHandlers()},Notifications.prototype.setupInteractionHandlers=function(){$(window).resize(this.checkWindowWidth)},Notifications.prototype.checkWindowWidth=function(){this.enabled=$(window).width()>=this.minWidth},Notifications.prototype.info=function(e){console.log(e)},PlayBack.prototype.init=function(e,t,i){var a=this;this.replayDetails=JSON.parse(e),this.sharedPresets=JSON.parse(t),this.map=new Map(this.replayDetails.map,this.replayDetails.tileSubDomains,function(e){e||a.fetch(i)}),this.markers=new Markers(this),this.timeline=new Timeline(this),this.events=new Events(this)},PlayBack.prototype.fetch=function(e){var t=e?webPath+"/cache/events/"+this.replayDetails.id+".json":webPath+"/fetch-data",i=e?"GET":"POST",a=this;$.ajax({url:t,type:i,dataType:"json",data:{id:this.replayDetails.id},success:this.prepData.bind(a),error:function(e,t,i){console.log("Error fetching playback data - Status: "+t+" - Message: "+i)}})},PlayBack.prototype.prepData=function(e){var t=this;this.markers.setupLayers(),_.each(e,function(e){"undefined"==typeof t.events.list[e.time]&&(t.events.list[e.time]=[]),t.events.list[e.time].push(e)}),this.timeline.setupScrubber(e),this.timeline.changeSpeed(this.timeline.speed),this.sharedPresets.centerLat?(this.map.handler.setView([this.sharedPresets.centerLat,this.sharedPresets.centerLng],this.sharedPresets.zoom),this.timeline.timePointer=this.sharedPresets.time,this.timeline.skipTime(this.sharedPresets.time)):this.timeline.startTimer()},Poi.prototype.setup=function(e){this.terrain=e,this.setupInteractionHandlers(),this.add()},Poi.prototype.setupInteractionHandlers=function(){var e=this;this.map.handler.on("zoomend",function(t){e.filterZoomLayers()})},Poi.prototype.add=function(){var e=this;$.getJSON(webPath+"/maps/"+this.terrain+"/poi.json",function(t){async.forEachOf(t,function(t,i,a){var n;"undefined"==typeof e.poiLayers[t.type]?("mount"!=t.type?(n=new L.featureGroup,n.addTo(e.map.handler)):n=new L.LayerGroup([],{makeBoundsAware:!0}),e.poiLayers[t.type]=n):n=e.poiLayers[t.type];var s="blank",o=[0,0],r=[30,30],p=[15,15];switch(t.type){case"hill":s="hill_ca",o=[10,0],r=[15,15],p=[7,7];break;case"rockarea":s="rockarea_ca",o=[10,0],r=[15,15],p=[7,7]}var l=L.icon({iconUrl:webPath+"/assets/images/map/markers/poi/"+s+".png",iconSize:r,iconAnchor:p,className:"poi-image--"+t.type}),c=e.map.gamePointToMapPoint(t.x,t.y),h=L.marker(e.map.rc.unproject([c[0],c[1]]),{icon:l,clickable:!1}).bindLabel(t.label,{noHide:!0,className:"poi poi-"+t.type,offset:o});n.addLayer(h),a()},function(t){e.ready=!0,e.filterZoomLayers()})}).fail(function(e){console.log("Error loading terrain POI, does the JSON file exist and is it valid JSON?",e)})},Poi.prototype.filterZoomLayers=function(){if(this.ready){var e=this,t=e.map.handler.getZoom();_.each(this.poiLayers,function(i,a){t<4&&"namecitycapital"!=a&&"namecity"!=a&&"mount"!=a&&e.map.handler.removeLayer(e.poiLayers[a]),t>3&&"mount"!=a&&e.poiLayers[a].addTo(e.map.handler),t>5&&"mount"==a&&e.poiLayers[a].addTo(e.map.handler),t<6&&"mount"==a&&e.map.handler.removeLayer(e.poiLayers[a])})}},ReplayList.prototype.init=function(){},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,100)}}(),Timeline.prototype.setupScrubber=function(e){console.log(e),this.timeBounds.min=parseInt(e[0].missionTime),this.timeBounds.max=parseInt(e[e.length-1].missionTime),"undefined"!=typeof this.playBack.sharedPresets.speed&&(this.speed=this.playBack.sharedPresets.speed),this.scrubber=document.getElementById("timeline__silder"),$(".timeline__silder__value").html(0),$(".timeline__silder").removeClass("timeline__silder--loading"),console.log("Range",this.timeBounds),this.timePointer=this.timeBounds.min,noUiSlider.create(this.scrubber,{start:this.timeBounds.min,animate:!1,connect:"lower",step:1,range:{min:this.timeBounds.min,max:this.timeBounds.max}}),this.setupInteractionHandlers()},Timeline.prototype.setupInteractionHandlers=function(){var e=this;this.scrubber.noUiSlider.on("slide",function(t){console.log("Sliding",Math.round(t[0])),e.skipTime(t[0])}),$("body").on("click",".timeline__toggle-playback",function(t){t.preventDefault(),e.playing?($(".timeline__toggle-playback .fa").removeClass("fa-pause").addClass("fa-play"),e.stopTimer()):($(".timeline__toggle-playback .fa").removeClass("fa-play").addClass("fa-pause"),e.startTimer())}),$("body").on("click",".timeline__speed",function(t){t.preventDefault(),e.changeSpeed($(this).data("speed"))}),$("body").on("click",".timeline__share",function(t){t.preventDefault(),e.stopTimer();var i=webPath+"/"+e.playBack.replayDetails.id+"/"+e.playBack.replayDetails.slug+"?playback",a=e.playBack.map.handler.getCenter();i+="&centerLat="+a.lat,i+="&centerLng="+a.lng,i+="&zoom="+e.playBack.map.handler.getZoom(),i+="&time="+e.timePointer,i+="&speed="+e.speed,e.playBack.trackTarget&&(i+="&track="+e.playBack.trackTarget),$(".timeline__share__details input").val(i)}),$("body").on("click",".timeline__fullscreen",function(e){e.preventDefault(),screenfull.enabled&&screenfull.toggle()})},Timeline.prototype.changeSpeed=function(e){$(".timeline__speed.active").removeClass("timeline__speed--active"),$('.timeline__speed[data-speed="'+e+'"]').addClass("timeline__speed--active"),this.speed=e,60==this.speed?this.timeJump=5:this.timeJump=1},Timeline.prototype.skipTime=function(e){this.timePointer=Math.round(e),this.playBack.markers.eventGroups.positions_vehicles.clearLayers(),this.playBack.markers.eventGroups.positions_infantry.clearLayers(),this.playBack.markers.list={},this.playBack.markers.currentIds.positions_vehicles=[],this.playBack.markers.currentIds.positions_infantry=[],this.playing||this.startTimer()},Timeline.prototype.startTimer=function(){var e=this;this.stopTimer(),this.playing=!0,$(".timeline__toggle-playback .fa").removeClass("fa-play").addClass("fa-pause"),this.playBack.sharedPresets.trackPlayer&&(playBack.trackTarget=this.playBack.sharedPresets.trackPlayer),function t(){if(e.playing){requestAnimFrame(t),e.now=Date.now(),e.delta=e.now-e.then;var i=1e3/e.speed;if(e.delta>i){console.log(e.timePointer,e.playing),e.scrubber.noUiSlider.set(e.timePointer);var a=new Date(null);a.setSeconds(e.timePointer),$(".noUi-handle").html(a.toISOString().substr(11,8)),parseInt($(".noUi-origin").css("left"))>70?$(".noUi-handle").addClass("left-time"):$(".noUi-handle").removeClass("left-time"),e.timePointer>=e.timeBounds.max?e.stopTimer():e.playBack.events.showNext(),e.then=e.now-e.delta%i}}}()},Timeline.prototype.stopTimer=function(){this.playing=!1,console.warn("Timer stopped"),$(".timeline__toggle-playback .fa").removeClass("fa-pause").addClass("fa-play")},$("document").ready(function(){var e=new ReplayList,t=new PlayBack;$(".playback-list").length&&e.init(),"undefined"!=typeof replayDetails&&t.init(replayDetails,sharedPresets,cacheAvailable)});