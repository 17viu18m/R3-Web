function Map(t,a){this.terrain=t,this.tileSubDomains=a,this.init()}function PlayBack(){this.map={},this.replayData={}}function PlayBackList(){}function Poi(t,a){this.terrain=a,this.map=t,this.ready=!1,this.poiLayers={},this.setupClickHandlers(),this.add()}Map.prototype.init=function(){var t=this;$.getJSON(webPath+"/maps/"+this.terrain+"/config.json",function(a){t.config=a,t.render()}).fail(function(){console.log("Error loading terrain config")})},Map.prototype.render=function(){console.log(this.config),this.handler=new L.Map("map",{minZoom:this.config.minZoom,maxZoom:this.config.maxZoom,zoom:this.config.initZoom,attributionControl:!1,measureControl:!0}),this.currentZoomLevel=this.config.initZoom,$("#map").css("background-color",this.config.bgColor),this.rc=new L.RasterCoords(this.handler,[this.config.width,this.config.height]);var t=this.rc.unproject([0,this.config.height]),a=this.rc.unproject([this.config.width,0]);this.mapBounds=new L.LatLngBounds(t,a);var i=this.mapBounds.pad(1);this.handler.setMaxBounds(i),this.setView([this.config.height/2,this.config.width/2],this.config.initZoom);var o=replayData.tileSubDomains?webPath.replace("//","//{s}."):webPath;this.layer=L.tileLayer(o+"/maps/"+this.terrain+"/tiles/{z}/{x}/{y}.png",{noWrap:!0,errorTileUrl:webPath+"/assets/images/map/error-tile.png"}).addTo(this.handler),this.setupClickHandlers(),new Poi(this,this.terrain)},Map.prototype.setupClickHandlers=function(){var t=this;this.handler.on("zoomend",function(a){t.currentZoomLevel=a.target._zoom,console.log("Zoom changed",t.currentZoomLevel)}),this.handler.on("dragend",function(a){var i=t.rc.project(t.handler.getCenter()),o=t.handler.getZoom();console.log(i,o)})},Map.prototype.setView=function(t,a){this.handler.setView(this.rc.unproject(t),a)},Map.prototype.gamePointToMapPoint=function(t,a){if("1"==this.config.doubleSize)var i=2*t,o=Math.abs(2*(a-this.config.height/2));else var i=t,o=Math.abs(parseFloat(a)-parseFloat(this.config.height));return[i,o]},Map.prototype.mapPointToGamePoint=function(t,a,i){if(i=i||!1,"object"==typeof t&&(a=t.y,t=t.x),"1"==this.config.doubleSize)var o=t/2,e=Math.abs((a-this.config.height)/2);else var o=t,e=Math.abs(parseFloat(a)+parseFloat(this.config.height));return i?map.gameToGrid(o,e):[o,e]},Map.prototype.gameToGrid=function(t,a){var i=Math.round(100*t/100)/100,o=Math.round(100*a/100)/100;return[i,o]},PlayBack.prototype.init=function(t){this.replayData=JSON.parse(t),this.map=new Map(this.replayData.map,this.replayData.tileSubDomains)},PlayBackList.prototype.init=function(){},Map.prototype.setupClickHandlers=function(){var t=this;this.map.handler.on("zoomend",function(a){t.filterZoomLayers()})},Poi.prototype.add=function(){var t=this;$.getJSON(webPath+"/maps/"+this.terrain+"/poi.json",function(a){async.forEachOf(a,function(a,i,o){var e;"undefined"==typeof t.poiLayers[a.type]?("mount"!=a.type?(e=new L.featureGroup,e.addTo(t.map.handler)):e=new L.LayerGroup([],{makeBoundsAware:!0}),t.poiLayers[a.type]=e):e=t.poiLayers[a.type];var n="blank",r=[0,0],s=[30,30],p=[15,15];switch(a.type){case"hill":n="hill_ca",r=[10,0],s=[15,15],p=[7,7];break;case"rockarea":n="rockarea_ca",r=[10,0],s=[15,15],p=[7,7]}var h=L.icon({iconUrl:webPath+"/assets/images/map/markers/poi/"+n+".png",iconSize:s,iconAnchor:p,className:"poi-image--"+a.type}),c=t.map.gamePointToMapPoint(a.x,a.y),l=L.marker(t.map.rc.unproject([c[0],c[1]]),{icon:h,clickable:!1}).bindLabel(a.label,{noHide:!0,className:"poi poi-"+a.type,offset:r});e.addLayer(l),o()},function(a){t.ready=!0,t.filterZoomLayers()})}).fail(function(t){console.log("Error loading terrain POI, does the JSON file exist and is it valid JSON?",t)})},Poi.prototype.filterZoomLayers=function(){if(this.ready){console.log("filtering zoom layers");var t=this,a=t.map.handler.getZoom();_.each(this.poiLayers,function(i,o){a<4&&"namecitycapital"!=o&&"namecity"!=o&&"mount"!=o&&t.map.handler.removeLayer(t.poiLayers[o]),a>3&&"mount"!=o&&t.poiLayers[o].addTo(t.map.handler),a>5&&"mount"==o&&t.poiLayers[o].addTo(t.map.handler),a<6&&"mount"==o&&t.map.handler.removeLayer(t.poiLayers[o])})}};var playBackList=new PlayBackList,playBack=new PlayBack;$("document").ready(function(){$(".playback-list").length&&playBackList.init(),"undefined"!=typeof replayData&&playBack.init(replayData)});