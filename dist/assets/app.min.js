function Events(){this.list={}}function Map(){this.terrain,this.tileSubDomains=!1}function Markers(){this.list={},this.matchedIcons={},this.icons={},this.maxZoomLevelForIndividualPlayerLabels=7,this.eventGroups={positions_vehicles:{},positions_infantry:{}},this.currentIds={positions_vehicles:[],positions_infantry:[]},this.unknownClasses=[]}function Notifications(){this.enabled=!0,this.minWidth=800}function PlayBack(){this.trackTarget=!1,this.zoomedToFirstPlayer=!1}function Players(){this.list={},this.groups={}}function Poi(){this.ready=!1,this.poiLayers={}}function ReplayList(){}function Timeline(){this.scrubber=null,this.speed=30,this.timeJump=1,this.timePointer=0,this.playing=!1,this.now,this.then=Date.now(),this.delta,this.timeBounds={min:0,max:0}}Events.prototype.showNext=function(){var e=this;"undefined"!=typeof this.list[timeline.timePointer]&&_.each(e.list[timeline.timePointer],function(t){var i=t.type,n=e.parseData(t.value);n&&e.actionType(i,t,n)}),timeline.timePointer+=timeline.timeJump},Events.prototype.parseData=function(e){try{var t=JSON.parse(e);return t}catch(t){return console.error(e),timeline.stopTimer(!0),!1}},Events.prototype.actionType=function(e,t,i){var n=this;if("positions_vehicles"==e||"positions_infantry"==e)markers.process(t,i,e);else switch(e){case"get_in":markers.removeUnit(Object.keys(i)[0]);break;case"player_disconnected":var a=i[Object.keys(i)[0]].id,s=players.getInfo(a);"undefined"!=typeof s&&notifications.info(s.name+" disconnected"),markers.removeUnit(Object.keys(i)[0]);break;case"player_connected":var a=i[Object.keys(i)[0]].id,s=players.getInfo(a);"undefined"!=typeof s&&notifications.info(s.name+" connected");break;case"unit_awake":markers.removeUnit(Object.keys(i)[0]);break;case"unit_unconscious":break;case"unit_killed":break;case"incoming_missile":n.projectileLaunch(i);break;default:console.warn("Unknown event",e)}},Events.prototype.projectileLaunch=function(e){var t=e.victim,i=e.attacker,n=map.gamePointToMapPoint(i.pos[0],i.pos[1]),a=this.markers.list[t.unit],s="undefined"!=typeof a&&a.getLatLng(),o=players.getInfo(t.id),r=L.circle(map.rc.unproject([n[0],n[1]]),50,{weight:1,color:"red",fillColor:"#f03",fillOpacity:.5,className:"missile-launch",clickable:!1}).addTo(map.m);if(setTimeout(function(){map.handler.removeLayer(r)},1e3),s){var l=L.marker(map.rc.unproject([n[0],n[1]]),{icon:L.icon({iconUrl:webPath+"/assets/images/map/markers/"+i.ammoType.toLowerCase()+".png",iconSize:[30,30],iconAnchor:[15,15],className:"projectile-"+i.ammoType.toLowerCase()}),clickable:!1}).addTo(map.handler);setTimeout(function(){l.setLatLng(s)},50),setTimeout(function(){map.handler.removeLayer(l)},1e3)}"undefined"!=typeof o&&notifications.info(i.ammoType+" Launch at "+o.name)},Map.prototype.init=function(e,t,i){var n=this;this.terrain=e,this.tileSubDomains=t,$.getJSON(webPath+"/maps/"+this.terrain+"/config.json",function(e){n.config=e,n.render(i)}).fail(function(){console.log("Error loading terrain config"),i(!0)})},Map.prototype.render=function(e){this.handler=new L.Map("map",{minZoom:this.config.minZoom,maxZoom:this.config.maxZoom,zoom:this.config.initZoom,attributionControl:!1}),this.currentZoomLevel=this.config.initZoom,$("#map").css("background-color",this.config.bgColor),this.rc=new L.RasterCoords(this.handler,[this.config.width,this.config.height]);var t=this.rc.unproject([0,this.config.height]),i=this.rc.unproject([this.config.width,0]);this.mapBounds=new L.LatLngBounds(t,i);var n=this.mapBounds.pad(1);this.handler.setMaxBounds(n),this.setView([this.config.height/2,this.config.width/2],this.config.initZoom);var a=this.tileSubDomains?webPath.replace("//","//{s}."):webPath;this.layer=L.tileLayer(a+"/maps/"+this.terrain+"/tiles/{z}/{x}/{y}.png",{noWrap:!0,errorTileUrl:webPath+"/assets/images/map/error-tile.png"}).addTo(this.handler),this.setupInteractionHandlers(),poi.init(this.terrain),e(!1)},Map.prototype.setupInteractionHandlers=function(){var e=this;this.handler.on("zoomend",function(t){e.currentZoomLevel=t.target._zoom,console.log("Zoom changed",e.currentZoomLevel)}),this.handler.on("dragend",function(t){var i=e.rc.project(e.handler.getCenter()),n=e.handler.getZoom();console.log(i,n)})},Map.prototype.setView=function(e,t){this.handler.setView(this.rc.unproject(e),t)},Map.prototype.gamePointToMapPoint=function(e,t){if("1"==this.config.doubleSize)var i=2*e,n=Math.abs(2*(t-this.config.height/2));else var i=e,n=Math.abs(parseFloat(t)-parseFloat(this.config.height));return[i,n]},Map.prototype.mapPointToGamePoint=function(e,t,i){if(i=i||!1,"object"==typeof e&&(t=e.y,e=e.x),"1"==this.config.doubleSize)var n=e/2,a=Math.abs((t-this.config.height)/2);else var n=e,a=Math.abs(parseFloat(t)+parseFloat(this.config.height));return i?map.gameToGrid(n,a):[n,a]},Map.prototype.gameToGrid=function(e,t){var i=Math.round(100*e/100)/100,n=Math.round(100*t/100)/100;return[i,n]},Markers.prototype.setupLayers=function(){this.eventGroups.positions_vehicles=new L.LayerGroup([],{makeBoundsAware:!1}),this.eventGroups.positions_infantry=new L.LayerGroup([],{makeBoundsAware:!1}),this.eventGroups.positions_vehicles.addTo(map.handler),this.eventGroups.positions_infantry.addTo(map.handler)},Markers.prototype.process=function(e,t,i){var n=this;console.log("process");var a={positions_vehicles:[],positions_infantry:[]};_.each(t,function(t,s){n.add(s,t,i,e.missionTime),n.currentIds[i].indexOf(s)<0&&n.currentIds[i].push(s),a[i].push(s)});var s=_.difference(n.currentIds[i],a[i]);_.each(s,function(t){if("undefined"!=typeof n.list[t]){var i=e.missionTime-n.list[t].timeUpdated;i>30&&n.removeUnit(t)}})},Markers.prototype.remove=function(e){if("undefined"!=typeof this.list[e]){this.eventGroups.positions_infantry.removeLayer(this.list[e]._leaflet_id),this.eventGroups.positions_vehicles.removeLayer(this.list[e]._leaflet_id);var t=playBack.currentIds.positions_infantry.indexOf(e),i=playBack.currentIds.positions_vehicles.indexOf(e);t>-1&&playBack.currentIds.positions_infantry.splice(t,1),i>-1&&playBack.currentIds.positions_vehicles.splice(i,1),delete this.list[e]}},Markers.prototype.convertFactionIdToSide=function(e){var t="unknown";switch(e){case 0:t="east";break;case 1:t="west";break;case 2:t="independant";break;case 3:t="civilian"}return t},Markers.prototype.add=function(e,t,i,n){var a=t.ico;if("iconLogic"!=a&&"iconVirtual"!=a){var s="positions_infantry"==i,o="positions_vehicles"==i,r=o?"vehicles":"infantry",l=t.cls,c=t.grp,p=t.crw,m=t.cgo,h=t.dir,d=t.ldr,u=map.gamePointToMapPoint(t.pos[0],t.pos[1]),f=this.convertFactionIdToSide(t.fac);console.log(t);var y="",g=!1,v=!1;""!=t.id&&(g=!0,y=players.getNameFromId(t.id),"undefined"==typeof players.list[t.id]&&players.add(t.id,y,c)),"iconPlane"!=a||g||(y="Jet"),o&&(a=this.matchClassToIcon(l,a)),o&&p.length&&p.length>1&&(y+=this.addCrewCargoToLabel("crew",p,t.id)),o&&m.length&&m.length>1&&(y+=this.addCrewCargoToLabel("cargo",m,t.id)),s&&g&&map.currentZoomLevel<this.maxZoomLevelForIndividualPlayerLabels&&(y=d?c.toUpperCase():" ");var k={iconSize:[30,30],iconAnchor:[15,15],className:"unit-marker unit-marker--"+a+" unit-marker__id--"+t.id,iconUrl:webPath+"/assets/images/map/markers/"+r+"/"};if("undefined"==typeof this.list[e]){var b=L.icon(_.extend(k,{iconUrl:k.iconUrl+f+"-"+a+".png"}));this.list[e]=L.marker(map.rc.unproject([u[0],u[1]]),{icon:b,clickable:!1,iconAngle:h}).bindLabel(y,{noHide:!0,className:"unit-marker__label unit-marker__label--"+i}),this.list[e].posType=i,this.list[e].originalLabel=y,this.list[e].faction=f,this.eventGroups[i].addLayer(this.list[e]),this.list[e].showLabel(),g&&!playBack.zoomedToFirstPlayer&&s&&(map.m.setView(map.rc.unproject([u[0],u[1]]),6),playBack.zoomedToFirstPlayer=!0)}else{this.list[e].setLatLng(map.rc.unproject([u[0],u[1]]));var w=$(".unit-marker__id--"+t.id);if(w.length){var P=this.calcShortestRotationAdjustment(this.getRotation(w.get(0)),h);this.list[e].setIconAngle(P)}if("undefined"!=typeof this.list[e].unconscious&&this.list[e].unconscious){var b=L.icon(_.extend(k,{iconUrl:k.iconUrl+"/unconscious.png",className:k.className+" unit-marker__label--unconscious"}));this.list[e].setIcon(b)}else if(this.list[e].posType!=i&&!v){var b=L.icon(_.extend(k,{iconUrl:k.iconUrl+f+"-"+a+".png"}));this.list[e].setIcon(b),this.list[e].posType=i}this.list[e].originalLabel=y,this.list[e].label.setContent(y),u[2]>10&&this.list[e].label.setContent(this.list[e].originalLabel+'<span class="player-marker-stat">'+String(Math.round(u[2]))+"m</span>")}if(this.list[e].timeUpdated=n,playBack.trackTarget&&playBack.trackTarget==t.id){this.list[e].setZIndexOffset(9999),$(".unit-marker--tracking").removeClass("unit-marker--tracking"),w.addClass("unit-marker--tracking");var T=map.m.latLngToLayerPoint(this.list[e].getLatLng()),I=T.distanceTo(map.m.latLngToLayerPoint(map.m.getCenter()));I>200&&map.m.panTo(map.rc.unproject([u[0],u[1]]))}}},Markers.prototype.addCrewCargoToLabel=function(e,t,i){var n='<span class="operation-'+e+'">';return _.each(t,function(e){if(e!=i){var t=players.getInfo(e);"undefined"!=typeof t&&(n+="<br>"+t.name)}}),n+="</span>"},Markers.prototype.matchClassToIcon=function(e,t){var i=this;if("undefined"==typeof this.matchedIcons[e]){var n=t,a=!1;return _.each(this.icons,function(t){e.indexOf(t.name)>-1&&(n=t.icon,i.matchedIcons[e]=t.icon,a=!0)}),a||i.unknownClasses.indexOf(e)==-1&&(console.warn(e,t),i.unknownClasses.push(e)),n}return i.matchedIcons[e]},Markers.prototype.getRotation=function(e){var t=window.getComputedStyle(e,null),i=t.getPropertyValue("-webkit-transform")||t.getPropertyValue("-moz-transform")||t.getPropertyValue("-ms-transform")||t.getPropertyValue("-o-transform")||t.getPropertyValue("transform")||"fail...";if("none"!==i){var n=i.split("(")[1];n=n.split(")")[0],n=n.split(",");var a=n[0],s=n[1],o=(n[2],n[3],Math.sqrt(a*a+s*s),Math.atan2(s,a)),r=Math.round(o*(180/Math.PI))}else var r=0;return r},Markers.prototype.calcShortestRotationAdjustment=function(e,t){var e,i;return e=e||0,i=e%360,i<0&&(i+=360),i<180&&t>i+180&&(e-=360),i>=180&&t<=i-180&&(e+=360),e+=t-i},Notifications.prototype.setup=function(){this.setupInteractionHandlers()},Notifications.prototype.setupInteractionHandlers=function(){$(window).resize(this.checkWindowWidth)},Notifications.prototype.checkWindowWidth=function(){this.enabled=$(window).width()>=this.minWidth},Notifications.prototype.info=function(e){console.log(e)},PlayBack.prototype.init=function(e,t,i){var n=this;this.replayDetails=JSON.parse(e),this.sharedPresets=JSON.parse(t),map.init(this.replayDetails.map,this.replayDetails.tileSubDomains,function(e){e||n.fetch(i)})},PlayBack.prototype.fetch=function(e){var t=e?webPath+"/cache/events/"+this.replayDetails.id+".json":webPath+"/fetch-data",i=e?"GET":"POST",n=this;$.ajax({url:t,type:i,dataType:"json",data:{id:this.replayDetails.id},success:this.prepData.bind(n),error:function(e,t,i){console.log("Error fetching playback data - Status: "+t+" - Message: "+i)}})},PlayBack.prototype.prepData=function(e){markers.setupLayers(),_.each(e,function(e){"undefined"==typeof events.list[e.missionTime]&&(events.list[e.missionTime]=[]),events.list[e.missionTime].push(e)}),timeline.setupScrubber(e),timeline.changeSpeed(timeline.speed),this.sharedPresets.centerLat?(map.handler.setView([this.sharedPresets.centerLat,this.sharedPresets.centerLng],this.sharedPresets.zoom),timeline.timePointer=this.sharedPresets.time,timeline.skipTime(this.sharedPresets.time)):timeline.startTimer()},Players.prototype.init=function(){},Players.prototype.add=function(e,t,i){this.list[e]={name:t},"undefined"==typeof this.groups[i]&&(this.groups[i]=[]),this.groups[i].push(e),this.updateList()},Players.prototype.getInfo=function(e){return _.find(this.list,function(t){return t.id==e})},Players.prototype.getNameFromId=function(e){var t=this.getInfo(e);return"undefined"==typeof t?"Unknown":t.name},Players.prototype.updateList=function(){},Poi.prototype.init=function(e){this.terrain=e,this.setupInteractionHandlers(),this.add()},Poi.prototype.setupInteractionHandlers=function(){var e=this;map.handler.on("zoomend",function(t){e.filterZoomLayers()})},Poi.prototype.add=function(){var e=this;$.getJSON(webPath+"/maps/"+this.terrain+"/poi.json",function(t){async.forEachOf(t,function(t,i,n){var a;"undefined"==typeof e.poiLayers[t.type]?("mount"!=t.type?(a=new L.featureGroup,a.addTo(map.handler)):a=new L.LayerGroup([],{makeBoundsAware:!0}),e.poiLayers[t.type]=a):a=e.poiLayers[t.type];var s="blank",o=[0,0],r=[30,30],l=[15,15];switch(t.type){case"hill":s="hill_ca",o=[10,0],r=[15,15],l=[7,7];break;case"rockarea":s="rockarea_ca",o=[10,0],r=[15,15],l=[7,7]}var c=L.icon({iconUrl:webPath+"/assets/images/map/markers/poi/"+s+".png",iconSize:r,iconAnchor:l,className:"poi-image--"+t.type}),p=map.gamePointToMapPoint(t.x,t.y),m=L.marker(map.rc.unproject([p[0],p[1]]),{icon:c,clickable:!1}).bindLabel(t.label,{noHide:!0,className:"poi poi-"+t.type,offset:o});a.addLayer(m),n()},function(t){e.ready=!0,e.filterZoomLayers()})}).fail(function(e){console.log("Error loading terrain POI, does the JSON file exist and is it valid JSON?",e)})},Poi.prototype.filterZoomLayers=function(){if(this.ready){var e=this,t=map.handler.getZoom();_.each(this.poiLayers,function(i,n){t<4&&"namecitycapital"!=n&&"namecity"!=n&&"mount"!=n&&map.handler.removeLayer(e.poiLayers[n]),t>3&&"mount"!=n&&e.poiLayers[n].addTo(map.handler),t>5&&"mount"==n&&e.poiLayers[n].addTo(map.handler),t<6&&"mount"==n&&map.handler.removeLayer(e.poiLayers[n])})}},ReplayList.prototype.init=function(){},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,100)}}(),Timeline.prototype.setupScrubber=function(e){this.timeBounds.min=parseInt(e[0].missionTime),this.timeBounds.max=parseInt(e[e.length-1].missionTime),"undefined"!=typeof playBack.sharedPresets.speed&&(this.speed=playBack.sharedPresets.speed),this.scrubber=document.getElementById("timeline__silder"),$(".timeline__silder__value").html(0),$(".timeline__silder").removeClass("timeline__silder--loading"),this.timePointer=this.timeBounds.min,noUiSlider.create(this.scrubber,{start:this.timeBounds.min,animate:!1,connect:"lower",step:1,range:{min:this.timeBounds.min,max:this.timeBounds.max}}),this.setupInteractionHandlers()},Timeline.prototype.setupInteractionHandlers=function(){var e=this;this.scrubber.noUiSlider.on("slide",function(t){console.log("Sliding",Math.round(t[0])),e.skipTime(t[0])}),$("body").on("click",".timeline__toggle-playback",function(t){t.preventDefault(),e.playing?($(".timeline__toggle-playback .fa").removeClass("fa-pause").addClass("fa-play"),e.stopTimer()):($(".timeline__toggle-playback .fa").removeClass("fa-play").addClass("fa-pause"),e.startTimer())}),$("body").on("click",".timeline__speed",function(t){t.preventDefault(),e.changeSpeed($(this).data("speed"))}),$("body").on("click",".timeline__share",function(t){t.preventDefault(),e.stopTimer();var i=webPath+"/"+playBack.replayDetails.id+"/"+playBack.replayDetails.slug+"?playback",n=playBack.map.handler.getCenter();i+="&centerLat="+n.lat,i+="&centerLng="+n.lng,i+="&zoom="+playBack.map.handler.getZoom(),i+="&time="+e.timePointer,i+="&speed="+e.speed,playBack.trackTarget&&(i+="&track="+playBack.trackTarget),$(".timeline__share__details input").val(i)}),$("body").on("click",".timeline__fullscreen",function(e){e.preventDefault(),screenfull.enabled&&screenfull.toggle()})},Timeline.prototype.changeSpeed=function(e){$(".timeline__speed.active").removeClass("timeline__speed--active"),$('.timeline__speed[data-speed="'+e+'"]').addClass("timeline__speed--active"),this.speed=e,60==this.speed?this.timeJump=5:this.timeJump=1},Timeline.prototype.skipTime=function(e){this.timePointer=Math.round(e),markers.eventGroups.positions_vehicles.clearLayers(),markers.eventGroups.positions_infantry.clearLayers(),markers.list={},markers.currentIds.positions_vehicles=[],markers.currentIds.positions_infantry=[],this.playing||this.startTimer()},Timeline.prototype.startTimer=function(){var e=this;this.stopTimer(),this.playing=!0,$(".timeline__toggle-playback .fa").removeClass("fa-play").addClass("fa-pause"),playBack.sharedPresets.trackPlayer&&(playBack.trackTarget=playBack.sharedPresets.trackPlayer),function t(){if(e.playing){requestAnimFrame(t),e.now=Date.now(),e.delta=e.now-e.then;var i=1e3/e.speed;if(e.delta>i){console.log(e.timePointer,e.playing),e.scrubber.noUiSlider.set(e.timePointer);var n=new Date(null);n.setSeconds(e.timePointer),$(".noUi-handle").html(n.toISOString().substr(11,8)),parseInt($(".noUi-origin").css("left"))>70?$(".noUi-handle").addClass("left-time"):$(".noUi-handle").removeClass("left-time"),e.timePointer>=e.timeBounds.max?e.stopTimer():events.showNext(),e.then=e.now-e.delta%i}}}()},Timeline.prototype.stopTimer=function(){this.playing=!1,console.warn("Timer stopped"),$(".timeline__toggle-playback .fa").removeClass("fa-pause").addClass("fa-play")};var replayList=new ReplayList,playBack=new PlayBack,events=new Events,players=new Players,markers=new Markers,poi=new Poi,map=new Map,timeline=new Timeline,notifications=new Notifications;$("document").ready(function(){$(".playback-list").length&&replayList.init(),"undefined"!=typeof replayDetails&&playBack.init(replayDetails,sharedPresets,cacheAvailable)});